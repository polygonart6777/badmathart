<aside class="notes">
  It's tough to just click through or let it animate. So I liked the idea of
  laying out all of the images at once. My first question that came up, does it
  always come back? The second question, is does it always come back after 24
  iterations?
</aside>

<style>
  .layout-images {
    margin-top: -300px;
  }

  .image-controls {
    padding-top: 0;
    margin-top: 0;
    display: flex;
    flex-direction: column;
    flex: 2 2 1 1;
    gap: 0;
  }

  button {
    padding: 10px 20px;
    margin: 5px;
    font-size: 16px;
  }

  input[type="file"] {
    margin: 10px;
  }

  select {
    padding: 5px;
    margin: 5px;
  }

  .iterations-grid {
    display: grid;
    grid-template-columns: repeat(8, 1fr);
    gap: 8px;
    width: 1200px;
    margin-left: -120px;
    padding-top: 20px;
  }

  .iteration-item {
    text-align: center;
    background: white;
    padding: 10px;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
  }

  .iteration-item canvas {
    border: 1px solid #ccc;
    image-rendering: pixelated;
    width: 80px;
    height: 80px;
  }

  .iteration-item h4 {
    margin: 5px 0;
    font-size: 14px;
    color: #333;
  }

  .loading {
    color: #666;
  }

  .complete {
    color: #28a745;
  }

  .matrices-wrapper {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    justify-content: center;
    gap: 30px;
  }

  .matrix {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
    padding: 10px;
    background: #fafafa;
    position: relative;
  }

  .matrix-cell {
    display: flex;
    align-items: center;
    gap: 8px;
    background: white;
    border-radius: 5px;
    border: 1px solid #e0e0e0;
  }

  .matrix-label {
    font-size: 18px;
    font-weight: 500;
    color: #555;
    min-width: 40px;
    text-align: center;
  }

  input {
    width: 60px;
    background: white;
    border: 1px solid #ccc;
    border-radius: 4px;
    color: #333;
    font-size: 14px;
    text-align: center;
    transition: border-color 0.2s ease;
  }

  .add-file {
    width: 200px;
    padding-right: 1rem;

    input {
      width: 100%;
    }
  }
</style>
<section class="layout-images">
  <div class="image-controls">

    <div class="matrices-wrapper">
      <div class="add-file">
        <input type="file" id="imageInput" accept="image/*" />
      </div>
      <div class="matrix-label">$A=$</div>
      <div class="matrix">
        <div class="matrix-cell">
          <label class="matrix-label">a₁₁</label>
          <input id="a11" value="1" />
        </div>
        <div class="matrix-cell">
          <label class="matrix-label">a₁₂</label>
          <input id="a12" value="1" />
        </div>
        <div class="matrix-cell">
          <label class="matrix-label">a₂₁</label>
          <input id="a21" value="1" />
        </div>
        <div class="matrix-cell">
          <label class="matrix-label">a₂₂</label>
          <input id="a22" value="0" />
        </div>
      </div>

      <select id="sizeSelect" onchange="updateSize()">
        <option value="14">14x14</option>
        <option value="15">15x15</option>
        <option value="16" selected>16x16</option>
        <option value="161">161x161</option>
      </select>

      <button onclick="generateAllIterations()">Show All Iterations</button>
    </div>

    <div class="iterations-grid" id="iterationsGrid"></div>
</section>

<script>
  let originalData = null;
  let currentSize = 16;

  document
    .getElementById("imageInput")
    .addEventListener("change", function (e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (e) {
        const img = new Image();
        img.onload = function () {
          loadImageData(img);
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    });

  function loadImageData(img) {
    const tempCanvas = document.createElement("canvas");
    tempCanvas.width = currentSize;
    tempCanvas.height = currentSize;
    const tempCtx = tempCanvas.getContext("2d");

    tempCtx.fillStyle = "white";
    tempCtx.fillRect(0, 0, currentSize, currentSize);
    tempCtx.drawImage(img, 0, 0, currentSize, currentSize);

    originalData = tempCtx.getImageData(0, 0, currentSize, currentSize);
  }

  function applyArnoldTransform(imageData, matrix) {
    const width = imageData.width;
    const height = imageData.height;
    const data = imageData.data;
    const newData = new Uint8ClampedArray(data.length);

    for (let y = 0; y < height; y++) {
      for (let x = 0; x < width; x++) {
        const newX = (matrix[0] * x + matrix[1] * y) % width;
        const newY = (matrix[2] * x + matrix[3] * y) % height;

        const oldIndex = (y * width + x) * 4;
        const newIndex = (newY * width + newX) * 4;

        for (let i = 0; i < 4; i++) {
          newData[newIndex + i] = data[oldIndex + i];
        }
      }
    }

    return new ImageData(newData, width, height);
  }

  function generateAllIterations() {
    if (!originalData) {
      alert("Please load an image first!");
      return;
    }

    clearGrid()

    iterations = 31;

    const grid = document.getElementById("iterationsGrid");

    const a11 = parseInt(document.getElementById("a11").value);
    const a12 = parseInt(document.getElementById("a12").value);
    const a21 = parseInt(document.getElementById("a21").value);
    const a22 = parseInt(document.getElementById("a22").value);

    let currentData = new ImageData(
      new Uint8ClampedArray(originalData.data),
      currentSize,
      currentSize,
    );

    for (let i = 0; i <= iterations; i++) {
      setTimeout(() => {
        const iterationDiv = document.createElement("div");
        iterationDiv.className = "iteration-item";

        const title = document.createElement("h4");
        title.textContent = i === 0 ? "Original" : `${i}`;
        iterationDiv.appendChild(title);

        const canvas = document.createElement("canvas");
        canvas.width = currentSize;
        canvas.height = currentSize;
        const ctx = canvas.getContext("2d");

        ctx.putImageData(currentData, 0, 0);
        iterationDiv.appendChild(canvas);

        grid.appendChild(iterationDiv);

        // Don't apply late iteration
        if (i < iterations) {
          currentData = applyArnoldTransform(currentData, [a11, a12, a21, a22]);
        }
      }, i * 100); // Stagger generation by 100ms each
    }
  }

  function updateSize() {
    currentSize = parseInt(document.getElementById("sizeSelect").value);
    originalData = null;
    clearGrid();
    loadImage();
  }

  function clearGrid() {
    document.getElementById("iterationsGrid").innerHTML = "";
  }

  function loadImage() {
    const img = new Image();
    img.onload = function () {
      loadImageData(img);
    };

    if (currentSize == 16) {
      img.src = "src/assets/16by16cat.png";
    }
    if (currentSize == 14) {
      img.src = "src/assets/14by14cat.png";
    }
    if (currentSize == 15) {
      img.src = "src/assets/15by15cat.png";
    }

    if (currentSize == 161) {
      img.src = "src/assets/161pixelcat.png";
    }

    console.log(currentSize);
  }

  loadImage();
</script>